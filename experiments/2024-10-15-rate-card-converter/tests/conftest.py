"""Shared pytest fixtures for the Rate Card Converter test suite.

Provides:
- settings: Test-specific Settings with in-memory SQLite and fake API key.
- db_session: In-memory SQLite AsyncSession with all tables created.
- mock_llm_mapper: Deterministic MockLLMMapper instance.
- sample_pdf_bytes: Raw bytes of the minimal test PDF fixture.
- sample_xlsx_bytes: Raw bytes of the minimal test Excel fixture.

The db_session fixture creates and destroys a fresh in-memory database for each
test function, ensuring test isolation. The engine is created fresh per test
(not cached) so that table state does not leak between tests.
"""

from __future__ import annotations

from collections.abc import AsyncGenerator
from pathlib import Path

import pytest
import pytest_asyncio
from sqlalchemy.ext.asyncio import AsyncSession, async_sessionmaker, create_async_engine

from src.config.settings import Settings
from src.infrastructure.database.models import Base
from src.infrastructure.mappers.mock_mapper import MockLLMMapper

_FIXTURES_DIR = Path(__file__).parent / "fixtures"


@pytest.fixture
def settings() -> Settings:
    """Return a Settings instance configured for testing.

    Uses in-memory SQLite so no real database file is created or modified.
    The openai_api_key is set to a fake value since tests use MockLLMMapper.

    Returns:
        A Settings instance with test-appropriate values.
    """
    return Settings(
        environment="local",
        openai_api_key="sk-test-fake-key-for-tests",
        openai_model="gpt-4o-mini",
        database_url="sqlite+aiosqlite:///:memory:",
        upload_dir="/tmp/rate_card_test_uploads",
        log_level="WARNING",
    )


@pytest_asyncio.fixture
async def db_session(settings: Settings) -> AsyncGenerator[AsyncSession, None]:
    """Yield an async SQLite session with all tables created in memory.

    Creates a fresh in-memory database engine for each test. Tables are
    created via Base.metadata.create_all before the session is yielded and
    the engine is disposed after the test completes.

    Args:
        settings: Test settings fixture providing the database URL.

    Yields:
        An AsyncSession bound to a fresh in-memory SQLite engine.
    """
    engine = create_async_engine(
        "sqlite+aiosqlite:///:memory:",
        connect_args={"check_same_thread": False},
    )
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

    factory = async_sessionmaker(engine, expire_on_commit=False)
    async with factory() as session:
        yield session

    await engine.dispose()


@pytest.fixture
def mock_llm_mapper() -> MockLLMMapper:
    """Return a fresh MockLLMMapper with zero call count.

    Returns:
        A new MockLLMMapper instance.
    """
    return MockLLMMapper()


@pytest.fixture
def sample_pdf_bytes() -> bytes:
    """Return the raw bytes of the minimal test PDF fixture.

    The fixture file is generated by running:
        python samples/generate_samples.py --test-fixtures

    Returns:
        Raw PDF bytes for use in extractor unit tests.
    """
    fixture_path = _FIXTURES_DIR / "sample.pdf"
    if not fixture_path.exists():
        pytest.skip(
            "Test fixture tests/fixtures/sample.pdf not found. "
            "Run: python samples/generate_samples.py --test-fixtures"
        )
    return fixture_path.read_bytes()


@pytest.fixture
def sample_xlsx_bytes() -> bytes:
    """Return the raw bytes of the minimal test Excel fixture.

    The fixture file is generated by running:
        python samples/generate_samples.py --test-fixtures

    Returns:
        Raw XLSX bytes for use in extractor unit tests.
    """
    fixture_path = _FIXTURES_DIR / "sample.xlsx"
    if not fixture_path.exists():
        pytest.skip(
            "Test fixture tests/fixtures/sample.xlsx not found. "
            "Run: python samples/generate_samples.py --test-fixtures"
        )
    return fixture_path.read_bytes()
